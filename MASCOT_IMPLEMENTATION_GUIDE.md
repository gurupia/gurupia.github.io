# 🎮 Mascot System Implementation Guide

## 목차
1. [다중 캐릭터 구현 가이드](#다중-캐릭터-구현-가이드)
2. [충돌 처리 시스템](#충돌-처리-시스템)
3. [구현 순서](#구현-순서)

---

## 다중 캐릭터 구현 가이드

### 📋 수정이 필요한 부분

#### 1. `mascot.js` - 핵심 구조 변경

**현재 상태** (Line 432-441):
- 단일 `mascot` 인스턴스만 생성
- 전역 변수로 하나의 캐릭터만 관리

**변경 필요 사항**:
- `mascot` 변수를 배열로 변경 (`mascots = []`)
- 여러 개의 `Mascot` 인스턴스를 생성/관리
- 캐릭터 추가/삭제 함수 구현
  - `addMascot(config)` - 새 캐릭터 추가
  - `removeMascot(id)` - 특정 캐릭터 삭제
  - `getMascotById(id)` - ID로 캐릭터 찾기
- 각 캐릭터별 독립적인 설정 저장 (localStorage에 배열로 저장)

#### 2. `index.html` - 설정 UI 확장

**현재 상태** (Line 721-755):
- 단일 캐릭터 설정 모달만 존재

**변경 필요 사항**:
- 캐릭터 목록 표시 섹션 추가
  - 현재 활성화된 모든 캐릭터 리스트
  - 각 캐릭터의 썸네일 이미지
  - 캐릭터별 간단한 정보 (크기, 상태)
- "새 캐릭터 추가" 버튼
- 각 캐릭터별 개별 설정 UI
  - 크기 조절 슬라이더
  - 이미지 업로드
  - 활성화/비활성화 토글
  - Float 애니메이션 토글
- 캐릭터 삭제 버튼 (각 캐릭터마다)
- 캐릭터 선택 시 해당 캐릭터 설정 표시

#### 3. `mascot.js` - 설정 저장/로드 로직

**현재 상태** (Line 56-70):
- 단일 캐릭터 설정만 로드
- localStorage 키: `mascot-image`, `mascot-size`, etc.

**변경 필요 사항**:
- 여러 캐릭터의 설정을 배열로 저장/로드
- 각 캐릭터에 고유 ID 부여 (UUID 또는 타임스탬프 기반)
- localStorage 구조 변경:
```javascript
{
  mascots: [
    {
      id: "unique-id-1",
      image: "data:image/png;base64...",
      isCustom: true,
      size: 64,
      disabled: false,
      noFloat: false,
      x: 100,
      y: 200,
      vx: 1.5,
      vy: -0.5
    },
    // ... more mascots
  ]
}
```

#### 4. `mascot.js` - 이벤트 리스너 관리

**현재 상태** (Line 156-300):
- `setupSettings()` 함수가 단일 캐릭터만 처리

**변경 필요 사항**:
- 특정 캐릭터를 선택해서 설정 변경
- 캐릭터 선택 이벤트 처리
- 각 캐릭터별 독립적인 설정 UI 업데이트
- 설정 변경 시 해당 캐릭터만 업데이트

#### 5. CSS 및 추가 고려사항

**`mascot-styles.css`**:
- 현재는 문제없음
- 여러 캐릭터가 겹칠 때 z-index 관리 필요
  - 클릭된 캐릭터를 최상단으로 이동
  - 또는 생성 순서대로 z-index 부여

**추가 고려사항**:
- 캐릭터끼리 충돌 감지 (아래 섹션 참조)
- 최대 캐릭터 수 제한 (성능 고려)
- 캐릭터 복제 기능

---

## 충돌 처리 시스템

### 🎮 충돌 감지 알고리즘

#### A. 원형 충돌 감지 (Circle Collision)

**특징**:
- ✅ 계산이 간단하고 빠름
- ✅ 성능이 우수함
- ⚠️ 정확도는 상대적으로 낮음

**방법**:
1. 두 캐릭터 중심점 간의 거리 계산
2. 공식: `distance = sqrt((x1-x2)² + (y1-y2)²)`
3. 충돌 조건: `distance < (radius1 + radius2)`

**적합한 경우**:
- 캐릭터가 대체로 정사각형/원형일 때
- 성능이 중요할 때
- 캐릭터 수가 많을 때 (10개 이상)

**구현 위치**:
- `Mascot` 클래스에 `getRadius()` 메서드 추가
- `checkCollisionWith(otherMascot)` 메서드 구현

#### B. 사각형 충돌 감지 (AABB - Axis-Aligned Bounding Box)

**특징**:
- ✅ 정확한 충돌 감지
- ✅ 다양한 크기의 캐릭터에 적합
- ⚠️ 원형보다 계산량 약간 많음

**방법**:
1. 각 캐릭터의 사각형 영역 계산
2. 두 사각형이 겹치는지 확인
3. 조건:
   - `x1 < x2 + width2`
   - `x1 + width1 > x2`
   - `y1 < y2 + height2`
   - `y1 + height1 > y2`

**적합한 경우**:
- 캐릭터 크기가 다양할 때
- 직사각형 캐릭터일 때
- 정확한 충돌이 필요할 때

**구현 위치**:
- `animate()` 함수 내에서 매 프레임마다 체크
- `element.getBoundingClientRect()` 활용

### 💫 충돌 시 반응 방식

#### A. 물리적 반발 (Physics-based Bounce)

**동작**:
- 충돌 시 서로 튕겨나감
- 속도 벡터를 반대 방향으로 반전
- 충돌 각도에 따라 반사 방향 계산

**추가 효과**:
- **질량 개념**: 크기에 따라 무게 다르게 설정
  - 큰 캐릭터는 작은 캐릭터보다 덜 밀림
  - `mass = size / 64` (기본 크기 대비)
- **탄성 계수**: 얼마나 튕길지 조절
  - `restitution = 0.8` (80% 반발)
  - 값이 작을수록 부드럽게 충돌

**구현 난이도**: ⭐ (쉬움)

#### B. 회피 행동 (Avoidance Behavior)

**동작**:
- 충돌 전에 미리 방향 전환
- 일정 거리 내에 다른 캐릭터가 있으면 피해감
- 더 자연스러운 움직임

**구현 방법**:
1. 충돌 예측 거리 설정 (예: 캐릭터 크기의 1.5~2배)
2. 예측 거리 내에 다른 캐릭터 감지
3. 반대 방향으로 속도 벡터 조정
4. 부드러운 회피를 위해 점진적으로 방향 변경

**장점**:
- 더 자연스러운 움직임
- 캐릭터가 겹치지 않음
- 생명체처럼 보임

**구현 난이도**: ⭐⭐⭐ (중간)

#### C. 겹침 방지 (Overlap Prevention)

**동작**:
- 충돌 감지 시 위치를 강제로 조정
- 겹치지 않는 최소 거리로 밀어냄
- 속도는 유지하되 위치만 조정

**구현 방법**:
1. 충돌 감지
2. 겹친 거리 계산
3. 각 캐릭터를 반대 방향으로 절반씩 이동
4. 또는 질량 비율에 따라 이동 거리 조정

**적합한 경우**:
- 캐릭터가 절대 겹치면 안 될 때
- 물리적 반발이 너무 강할 때
- 안정적인 움직임이 필요할 때

**구현 난이도**: ⭐⭐ (쉬움-중간)

#### D. 상호작용 이벤트 (Interaction Events)

**동작**:
- 충돌 시 특별한 애니메이션/효과
- 말풍선으로 대화 표시
- 이벤트 트리거

**예시 메시지**:
- "어! 너도 여기 있었어?"
- "비켜! 😤"
- "같이 놀자! 😊"
- "앗! 미안해!"
- "조심해!"

**추가 효과**:
- 파티클 효과 (별, 하트 등)
- 색상 변경 (잠깐 번쩍임)
- 사운드 효과
- 애니메이션 변경 (running 상태로 전환)

**구현 난이도**: ⭐⭐ (쉬움-중간)

### ⚡ 성능 최적화 방법

#### A. 공간 분할 (Spatial Partitioning)

**개념**:
- 화면을 그리드로 나눔 (예: 200x200px 셀)
- 같은 그리드 내의 캐릭터끼리만 충돌 체크
- O(n²) → O(n) 복잡도로 개선

**구현 방법**:
1. 화면을 그리드로 분할
2. 각 캐릭터가 속한 셀 계산
3. 같은 셀 + 인접 셀의 캐릭터끼리만 체크

**필요한 경우**:
- 캐릭터가 10개 이상일 때
- 성능 문제가 발생할 때

**구현 난이도**: ⭐⭐⭐⭐ (어려움)

#### B. 충돌 체크 빈도 조절

**방법**:
- 매 프레임마다 체크하지 않음
- 일정 간격으로 체크 (예: 3~5 프레임마다)
- 프레임 카운터 사용

**구현 예시**:
```javascript
// 3프레임마다 한 번씩 체크
if (frameCount % 3 === 0) {
  checkCollisions();
}
```

**장점**:
- CPU 사용량 감소
- 눈에 띄는 차이 없음 (60fps → 20fps 체크)

**구현 난이도**: ⭐ (매우 쉬움)

#### C. 거리 기반 사전 필터링

**방법**:
1. 먼저 간단한 거리 계산 (제곱근 없이)
2. `distanceSquared = (x1-x2)² + (y1-y2)²`
3. 임계값보다 가까운 경우만 정밀 체크
4. 멀리 있는 캐릭터는 무시

**장점**:
- 제곱근 계산 생략으로 성능 향상
- 간단하고 효과적

**구현 난이도**: ⭐⭐ (쉬움)

### 🔧 구현 위치 및 구조

#### `mascot.js` 수정 필요 부분

**1. 전역 충돌 관리자 추가** (Line 432-441 부근)
```javascript
// 추가할 내용:
- mascots 배열 (모든 인스턴스 관리)
- checkCollisions() 함수
- 충돌 설정 객체 (collisionSettings)
```

**2. `Mascot` 클래스 내부 메서드 추가**
```javascript
// 추가할 메서드:
- checkCollisionWith(otherMascot) - 충돌 감지
- handleCollision(otherMascot) - 충돌 처리
- getRadius() - 충돌 반경 계산
- getBounds() - 사각형 영역 반환
```

**3. 충돌 감지 타이밍** (Line 371-419, `animate()` 함수)
```javascript
// 호출 순서:
1. 위치 업데이트 (vx, vy 적용)
2. 벽 충돌 체크 (Line 385-392)
3. 다른 캐릭터들과 충돌 체크 ← 여기에 추가
4. 위치 적용 (element.style.left/top)
```

### ⚙️ 설정 옵션 제안

사용자가 선택할 수 있는 옵션 (Settings UI에 추가):

#### 기본 옵션
- ✅ **충돌 활성화/비활성화**: 체크박스
  - `<input type="checkbox" id="collision-enabled">`
  
#### 고급 옵션
- ✅ **충돌 반응 타입**: 드롭다운
  - 옵션: "반발", "회피", "무시", "상호작용"
  - `<select id="collision-type">`

- ✅ **충돌 강도**: 슬라이더 (0.1 ~ 2.0)
  - 얼마나 세게 튕길지
  - `<input type="range" id="collision-strength" min="0.1" max="2" step="0.1">`

- ✅ **상호작용 메시지**: 체크박스
  - 충돌 시 말풍선 표시 여부
  - `<input type="checkbox" id="collision-messages">`

- ✅ **회피 거리**: 슬라이더 (1.0 ~ 3.0배)
  - 캐릭터 크기의 몇 배 거리에서 회피할지
  - `<input type="range" id="avoidance-distance" min="1" max="3" step="0.1">`

### 📊 구현 방식 비교

| 방식 | 구현 난이도 | 성능 | 자연스러움 | 추천 대상 |
|------|------------|------|-----------|----------|
| 원형 충돌 + 반발 | ⭐ | ⭐⭐⭐ | ⭐⭐ | 초보자, 빠른 구현 |
| AABB + 반발 | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 정확도 중요 |
| 회피 행동 | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ | 자연스러움 중요 |
| 물리 엔진 통합 | ⭐⭐⭐⭐ | ⭐ | ⭐⭐⭐⭐⭐ | 고급 사용자 |

### 🎯 추천 구현 방식

#### 초보자/간단한 구현
1. **원형 충돌 감지** 사용
2. **물리적 반발** 적용
3. 충돌 시 속도 벡터 반전
4. 간단한 말풍선 표시

**예상 코드량**: ~50줄

#### 중급 구현
1. **AABB 충돌 감지** 사용
2. **질량 기반 반발** 적용
3. **상호작용 메시지** 추가
4. 충돌 설정 UI 구현

**예상 코드량**: ~100줄

#### 고급 구현
1. **AABB 충돌 감지** + **회피 행동** 조합
2. **질량 기반 물리 시뮬레이션**
3. 충돌 예측 및 자연스러운 회피
4. 캐릭터별 성격 설정 (공격적/수줍음 등)
5. 공간 분할 최적화

**예상 코드량**: ~200줄

### 🎨 재미있는 추가 아이디어

#### 1. 그룹 행동 (Flocking Behavior)
- 일정 시간 후 캐릭터들이 모임
- 또는 특정 조건에서 흩어짐
- 리더 캐릭터를 따라다님

#### 2. 대화 시스템
- 충돌 시 서로 대화하는 듯한 말풍선
- 순차적으로 표시 (A가 말하면 B가 대답)
- 대화 내용이 상황에 맞게 변경

#### 3. 충돌 이펙트
- **파티클 효과**: 별, 하트, 불꽃 등
- **번쩍임**: 충돌 순간 색상 변경
- **진동**: 화면 흔들림 (강한 충돌 시)

#### 4. 사운드 효과
- 충돌 시 효과음 재생
- 캐릭터 크기에 따라 다른 소리
- 충돌 강도에 따라 볼륨 조절

#### 5. 추격/도망 모드
- 한 캐릭터가 다른 캐릭터를 쫓아감
- 클릭한 캐릭터가 도망감
- 일정 시간 후 자동으로 해제

#### 6. 감정 시스템
- 충돌 횟수에 따라 감정 변화
- 화난 상태: 빨간색 테두리, 빠른 움직임
- 행복한 상태: 느린 움직임, 하트 이펙트

#### 7. 팀 시스템
- 캐릭터를 팀으로 나눔
- 같은 팀끼리는 충돌하지 않음
- 다른 팀과는 경쟁/협력

---

## 구현 순서

### Phase 1: 다중 캐릭터 기본 구조 (필수)

1. **데이터 구조 설계**
   - [ ] `mascots` 배열로 변경
   - [ ] 각 캐릭터에 고유 ID 부여
   - [ ] localStorage 구조 재설계

2. **UI 확장**
   - [ ] 캐릭터 목록 UI 추가
   - [ ] "새 캐릭터 추가" 버튼
   - [ ] 캐릭터 삭제 버튼

3. **인스턴스 관리**
   - [ ] `addMascot()` 함수 구현
   - [ ] `removeMascot()` 함수 구현
   - [ ] 여러 `Mascot` 객체 생성/삭제 로직

4. **설정 저장/로드**
   - [ ] localStorage에 배열 형태로 저장
   - [ ] 페이지 로드 시 모든 캐릭터 복원
   - [ ] 개별 캐릭터 설정 업데이트

### Phase 2: 충돌 시스템 기본 (선택)

5. **충돌 감지 구현**
   - [ ] 원형 충돌 감지 알고리즘
   - [ ] `checkCollisionWith()` 메서드
   - [ ] 전역 `checkCollisions()` 함수

6. **충돌 반응 구현**
   - [ ] 물리적 반발 로직
   - [ ] 속도 벡터 조정
   - [ ] 위치 보정

7. **충돌 설정 UI**
   - [ ] 충돌 활성화/비활성화 옵션
   - [ ] 충돌 강도 슬라이더
   - [ ] 설정 저장/로드

### Phase 3: 고급 기능 (선택)

8. **회피 행동**
   - [ ] 충돌 예측 로직
   - [ ] 회피 거리 설정
   - [ ] 부드러운 방향 전환

9. **상호작용 시스템**
   - [ ] 충돌 시 메시지 표시
   - [ ] 대화 시스템
   - [ ] 이펙트 추가

10. **성능 최적화**
    - [ ] 충돌 체크 빈도 조절
    - [ ] 거리 기반 필터링
    - [ ] 공간 분할 (캐릭터 많을 때)

### Phase 4: 추가 기능 (선택)

11. **재미 요소**
    - [ ] 그룹 행동
    - [ ] 감정 시스템
    - [ ] 사운드 효과
    - [ ] 파티클 이펙트

12. **테스트 및 디버깅**
    - [ ] 다양한 캐릭터 수로 테스트
    - [ ] 성능 측정 (FPS)
    - [ ] 버그 수정
    - [ ] 사용자 피드백 반영

---

## 참고 사항

### 성능 고려사항
- **캐릭터 수 제한**: 권장 최대 20개
- **충돌 체크 최적화**: 10개 이상일 때 필수
- **애니메이션 프레임**: requestAnimationFrame 사용 유지

### 호환성
- 모든 모던 브라우저 지원
- localStorage 용량 제한 고려 (5MB)
- 이미지 크기 최적화 (Base64 인코딩)

### 확장 가능성
- 물리 엔진 라이브러리 통합 가능 (Matter.js, Box2D)
- WebGL로 렌더링 최적화 가능
- WebWorker로 충돌 계산 분리 가능

---

**작성일**: 2025-12-04  
**버전**: 1.0  
**작성자**: AI Assistant
